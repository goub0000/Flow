name: Async Data Enrichment Automation (5-10x Faster)

on:
  schedule:
    # Daily enrichment at 2:00 AM UTC (30 critical priority universities)
    # Async version: ~2-5 minutes vs sync ~20-30 minutes
    - cron: '0 2 * * *'

    # Weekly enrichment every Sunday at 3:00 AM UTC (100 high priority universities)
    # Async version: ~7-13 minutes vs sync ~1-2 hours
    - cron: '0 3 * * 0'

    # Monthly enrichment on the 1st at 4:00 AM UTC (300 medium priority universities)
    # Async version: ~20-40 minutes vs sync ~3-5 hours
    - cron: '0 4 1 * *'

  # Allow manual triggering for testing
  workflow_dispatch:
    inputs:
      enrichment_type:
        description: 'Type of async enrichment to run'
        required: true
        default: 'daily'
        type: choice
        options:
          - daily
          - weekly
          - monthly

jobs:
  trigger-async-enrichment:
    runs-on: ubuntu-latest

    steps:
      - name: Determine enrichment type
        id: enrichment-type
        run: |
          # Determine which enrichment to run based on schedule or manual input
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "type=${{ github.event.inputs.enrichment_type }}" >> $GITHUB_OUTPUT
          elif [ "$(date +%d)" == "01" ]; then
            # Monthly on the 1st
            echo "type=monthly" >> $GITHUB_OUTPUT
          elif [ "$(date +%u)" == "7" ]; then
            # Weekly on Sunday
            echo "type=weekly" >> $GITHUB_OUTPUT
          else
            # Daily
            echo "type=daily" >> $GITHUB_OUTPUT
          fi

      - name: Trigger Daily Async Enrichment
        if: steps.enrichment-type.outputs.type == 'daily'
        run: |
          echo "Triggering ASYNC daily enrichment (30 critical priority universities)..."
          echo "Expected duration: 2-5 minutes (vs sync: 20-30 minutes)"
          curl -X POST \
            https://web-production-51e34.up.railway.app/api/v1/enrichment/daily-async \
            -H "Content-Type: application/json" \
            -w "\nHTTP Status: %{http_code}\n"

      - name: Trigger Weekly Async Enrichment
        if: steps.enrichment-type.outputs.type == 'weekly'
        run: |
          echo "Triggering ASYNC weekly enrichment (100 high priority universities)..."
          echo "Expected duration: 7-13 minutes (vs sync: 1-2 hours)"
          curl -X POST \
            https://web-production-51e34.up.railway.app/api/v1/enrichment/weekly-async \
            -H "Content-Type: application/json" \
            -w "\nHTTP Status: %{http_code}\n"

      - name: Trigger Monthly Async Enrichment
        if: steps.enrichment-type.outputs.type == 'monthly'
        run: |
          echo "Triggering ASYNC monthly enrichment (300 medium priority universities)..."
          echo "Expected duration: 20-40 minutes (vs sync: 3-5 hours)"
          curl -X POST \
            https://web-production-51e34.up.railway.app/api/v1/enrichment/monthly-async \
            -H "Content-Type: application/json" \
            -w "\nHTTP Status: %{http_code}\n"

      - name: Check enrichment status
        run: |
          echo "Waiting 5 seconds for async job to start..."
          sleep 5
          echo "Checking async enrichment job status..."
          curl -X GET \
            https://web-production-51e34.up.railway.app/api/v1/enrichment/status \
            -H "Content-Type: application/json"

      - name: Performance Summary
        run: |
          echo "========================================="
          echo "Async Enrichment Performance Benefits"
          echo "========================================="
          echo "Daily:   2-5 min  (vs sync: 20-30 min) = 6-10x faster"
          echo "Weekly:  7-13 min (vs sync: 1-2 hrs)   = 7-10x faster"
          echo "Monthly: 20-40 min (vs sync: 3-5 hrs)  = 7-9x faster"
          echo "========================================="
