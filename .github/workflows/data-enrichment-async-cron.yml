name: Aggressive Data Enrichment (Maximum Speed)

on:
  schedule:
    # Run every 2 hours for continuous enrichment
    - cron: '0 */2 * * *'

    # Additional US-focused run every 4 hours (College Scorecard priority)
    - cron: '30 */4 * * *'

  # Allow manual triggering
  workflow_dispatch:
    inputs:
      enrichment_type:
        description: 'Type of enrichment to run'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - us-only
          - international

jobs:
  us-university-enrichment:
    runs-on: ubuntu-latest
    name: US Universities (College Scorecard)

    steps:
      - name: Enrich US Universities (500 batch)
        run: |
          echo "========================================="
          echo "US University Enrichment (College Scorecard)"
          echo "========================================="
          echo "Target: 500 US universities with official government data"
          echo "Data: SAT/ACT scores, acceptance rates, tuition, graduation rates"
          echo ""

          curl -X POST \
            "https://web-production-51e34.up.railway.app/api/v1/enrichment/us-universities?limit=500" \
            -H "Content-Type: application/json" \
            -w "\nHTTP Status: %{http_code}\n"

      - name: Check US Stats
        run: |
          echo ""
          echo "US University Statistics:"
          curl -s "https://web-production-51e34.up.railway.app/api/v1/enrichment/us-stats" | jq '.'

  general-enrichment:
    runs-on: ubuntu-latest
    name: General Enrichment (All Universities)

    steps:
      - name: Trigger Large Batch Enrichment (500 universities)
        run: |
          echo "========================================="
          echo "General University Enrichment"
          echo "========================================="
          echo "Target: 500 universities (US prioritized first)"
          echo ""

          # Monthly-sized batch but run frequently
          curl -X POST \
            https://web-production-51e34.up.railway.app/api/v1/enrichment/monthly-async \
            -H "Content-Type: application/json" \
            -w "\nHTTP Status: %{http_code}\n"

      - name: Trigger Additional Batch
        run: |
          echo ""
          echo "Starting second enrichment batch..."
          sleep 5

          curl -X POST \
            https://web-production-51e34.up.railway.app/api/v1/enrichment/weekly-async \
            -H "Content-Type: application/json" \
            -w "\nHTTP Status: %{http_code}\n"

  cleanup-and-status:
    runs-on: ubuntu-latest
    name: Cleanup & Status
    needs: [us-university-enrichment, general-enrichment]

    steps:
      - name: Cleanup Stuck Jobs
        run: |
          echo "Cleaning up any stuck jobs..."
          curl -X POST \
            https://web-production-51e34.up.railway.app/api/v1/enrichment/cleanup-stuck \
            -H "Content-Type: application/json"

      - name: Check Overall Status
        run: |
          echo ""
          echo "========================================="
          echo "Enrichment Status Summary"
          echo "========================================="

          curl -s "https://web-production-51e34.up.railway.app/api/v1/enrichment/status" | \
            jq '{
              total_jobs: .total_jobs,
              running: [.jobs[] | select(.status == "running")] | length,
              completed_today: [.jobs[] | select(.status == "completed")] | length,
              recent_jobs: [.jobs[:5] | .[] | {id: .job_id, status: .status, processed: .universities_processed, updated: .universities_updated}]
            }'

      - name: Database Coverage Report
        run: |
          echo ""
          echo "========================================="
          echo "Database Coverage Analysis"
          echo "========================================="

          curl -s "https://web-production-51e34.up.railway.app/api/v1/enrichment/analyze" | \
            jq '{
              total_universities: .total_universities,
              critical_fields: [.fields[] | select(.priority == "CRITICAL") | {field: .field, filled: .filled_count, null_pct: .null_percentage}]
            }'

      - name: Summary
        run: |
          echo ""
          echo "========================================="
          echo "AGGRESSIVE ENRICHMENT COMPLETE"
          echo "========================================="
          echo "Schedule: Every 2 hours (general) + Every 4 hours (US-focused)"
          echo "Batch sizes: 500 US + 500 general per run"
          echo "Expected daily processing: ~6,000 universities"
          echo "Full database coverage: ~3 days"
          echo "========================================="
