name: Data Enrichment (Balanced)

on:
  schedule:
    # Run every 8 hours (reduced from 2 hours to prevent server overload)
    - cron: '0 */8 * * *'

  # Allow manual triggering
  workflow_dispatch:
    inputs:
      enrichment_type:
        description: 'Type of enrichment to run'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - us-only
          - international

jobs:
  us-university-enrichment:
    runs-on: ubuntu-latest
    name: US Universities (College Scorecard)
    timeout-minutes: 5

    steps:
      - name: Enrich US Universities (100 batch)
        run: |
          echo "========================================="
          echo "US University Enrichment (College Scorecard)"
          echo "========================================="
          echo "Target: 100 US universities with official government data"
          echo "Data: SAT/ACT scores, acceptance rates, tuition, graduation rates"
          echo ""

          curl -X POST \
            "https://web-production-51e34.up.railway.app/api/v1/enrichment/us-universities?limit=100" \
            -H "Content-Type: application/json" \
            -w "\nHTTP Status: %{http_code}\n" \
            --max-time 120 || echo "Request timed out"

      - name: Check US Stats
        run: |
          echo ""
          echo "US University Statistics:"
          curl -s --max-time 30 "https://web-production-51e34.up.railway.app/api/v1/enrichment/us-stats" | jq '.' || echo "Failed to get stats"

  general-enrichment:
    runs-on: ubuntu-latest
    name: General Enrichment (All Universities)
    timeout-minutes: 5

    steps:
      - name: Trigger Batch Enrichment (100 universities)
        run: |
          echo "========================================="
          echo "General University Enrichment"
          echo "========================================="
          echo "Target: 100 universities (US prioritized first)"
          echo ""

          # Smaller batch to prevent overload
          curl -X POST \
            "https://web-production-51e34.up.railway.app/api/v1/enrichment/weekly-async" \
            -H "Content-Type: application/json" \
            -w "\nHTTP Status: %{http_code}\n" \
            --max-time 120 || echo "Request timed out"

  cleanup-and-status:
    runs-on: ubuntu-latest
    name: Cleanup & Status
    needs: [us-university-enrichment, general-enrichment]
    timeout-minutes: 5

    steps:
      - name: Cleanup Stuck Jobs
        run: |
          echo "Cleaning up any stuck jobs..."
          curl -X POST \
            https://web-production-51e34.up.railway.app/api/v1/enrichment/cleanup-stuck \
            -H "Content-Type: application/json" \
            --max-time 60 || echo "Cleanup request timed out"

      - name: Check Overall Status
        run: |
          echo ""
          echo "========================================="
          echo "Enrichment Status Summary"
          echo "========================================="

          curl -s --max-time 30 "https://web-production-51e34.up.railway.app/api/v1/enrichment/status" | \
            jq '{
              total_jobs: .total_jobs,
              running: [.jobs[] | select(.status == "running")] | length,
              completed_today: [.jobs[] | select(.status == "completed")] | length,
              recent_jobs: [.jobs[:5] | .[] | {id: .job_id, status: .status, processed: .universities_processed, updated: .universities_updated}]
            }' || echo "Failed to get status"

      - name: Summary
        run: |
          echo ""
          echo "========================================="
          echo "DATA ENRICHMENT COMPLETE"
          echo "========================================="
          echo "Schedule: Every 8 hours (balanced for server health)"
          echo "Batch sizes: 100 US + 100 general per run"
          echo "Expected daily processing: ~600 universities"
          echo "Full database coverage: ~30 days"
          echo "========================================="
