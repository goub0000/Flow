# Row Level Security (RLS) Policies Setup Guide

## üéØ What This Fixes

Your application workflow test is currently blocked by this error:
```
Error: "new row violates row-level security policy for table 'applications'"
```

This guide will help you configure the necessary database permissions to allow:
- ‚úÖ Students to create and view their applications
- ‚úÖ Institutions to receive and manage applications
- ‚úÖ Proper document transfer between student and institution
- ‚úÖ Role-based access control for admins

---

## üöÄ Quick Setup (Recommended)

### Method 1: Using Supabase SQL Editor (5 minutes)

**Step 1:** Open Supabase Dashboard
- Go to: https://supabase.com/dashboard
- Select your project: `wmuarotbdjhqbyjyslqg`

**Step 2:** Open SQL Editor
- Click **SQL Editor** in the left sidebar
- Click **New query** button

**Step 3:** Execute the SQL Script
- Open the file: `setup_rls_policies.sql` (in this directory)
- Copy the entire contents (Ctrl+A, Ctrl+C)
- Paste into the SQL Editor
- Click **Run** button (bottom right)

**Step 4:** Verify Success
You should see output like:
```
NOTICE: ‚úì RLS policies successfully configured!
NOTICE: ‚úì Applications table: 8 policies created
NOTICE: ‚úì Programs table: 4 policies created
```

**Step 5:** Re-run Your Test
```bash
cd "C:\Flow_App (1)\Flow"
python test_application_workflow.py
```

‚úÖ **Expected Result:** All tests should now pass!

---

### Method 2: Using Python Script (Alternative)

If you prefer automation:

```bash
cd "C:\Flow_App (1)\Flow"
python setup_rls_policies.py
```

**Note:** This requires the Supabase Python client and may have permission limitations. Method 1 (SQL Editor) is more reliable.

---

## üìã What Gets Configured

The setup script creates comprehensive RLS policies:

### Applications Table (8 Policies)

| Policy | Who | Action | Condition |
|--------|-----|--------|-----------|
| **Create Own** | Students | INSERT | Must be their own application |
| **View Own** | Students | SELECT | Can see only their applications |
| **Update Draft** | Students | UPDATE | Only before submission |
| **Delete Draft** | Students | DELETE | Only before submission |
| **View Received** | Institutions | SELECT | Applications to their programs |
| **Update Received** | Institutions | UPDATE | Can review and update status |
| **Admin View All** | Admins | SELECT | Full access to all applications |
| **Admin Update All** | Admins | UPDATE | Can modify any application |

### Programs Table (4 Policies)

| Policy | Who | Action | Condition |
|--------|-----|--------|-----------|
| **View Active** | Everyone | SELECT | Only active programs |
| **Create Own** | Institutions | INSERT | Their own programs only |
| **Update Own** | Institutions | UPDATE | Their own programs only |
| **Delete Own** | Institutions | DELETE | Their own programs only |

---

## üîç Verification

After running the setup, verify policies are active:

### In Supabase Dashboard:
1. Go to **Database** ‚Üí **applications** table
2. Click the **Policies** tab
3. You should see 8 policies listed

### SQL Verification:
```sql
SELECT tablename, policyname, cmd
FROM pg_policies
WHERE tablename = 'applications'
ORDER BY policyname;
```

### Test in Your Application:
```bash
python test_application_workflow.py
```

You should see:
```
[PASS] All tests passed successfully!

Test Results:
  [PASS] Student registration
  [PASS] Institution registration
  [PASS] Program creation
  [PASS] Application submission with 3 documents
  [PASS] Student can view their application
  [PASS] Institution receives application
  [PASS] Institution can view all documents
  [PASS] Status update to 'under_review'
  [PASS] Status update to 'accepted'
  [PASS] Statistics generation
```

---

## üõ†Ô∏è Troubleshooting

### Issue: "Permission denied for table applications"

**Cause:** RLS is enabled but no policies exist yet

**Solution:** Run the setup script

---

### Issue: "Policies already exist" errors

**Cause:** You're running the setup script multiple times

**Solution:** This is safe to ignore. The script uses `DROP POLICY IF EXISTS` to handle this gracefully.

---

### Issue: "auth.uid() returns null"

**Cause:** User is not properly authenticated

**Solution:**
1. Check that you're passing the JWT token in Authorization header
2. Verify token is not expired
3. Ensure token was generated by Supabase auth.sign_in()

---

### Issue: "UUID type mismatch"

**Cause:** Some IDs might be stored as text instead of UUID

**Solution:** The script uses `::text` casting to handle both formats

---

## üìö Understanding RLS

### What is Row Level Security?

RLS is a PostgreSQL feature that restricts database access at the row level. Instead of granting table-wide permissions, you can create policies that determine which rows a user can access based on their identity or role.

### Why Do We Need It?

Without RLS:
- ‚ùå Any authenticated user could see ALL applications
- ‚ùå Students could modify other students' applications
- ‚ùå Institutions could see applications to other institutions

With RLS:
- ‚úÖ Students see only their own applications
- ‚úÖ Institutions see only applications submitted to them
- ‚úÖ Data privacy is enforced at the database level
- ‚úÖ Even if frontend code has a bug, data remains secure

### Policy Structure

```sql
CREATE POLICY "policy_name"
ON table_name
FOR operation  -- INSERT, SELECT, UPDATE, DELETE
TO role        -- authenticated, anon, specific role
USING (condition)      -- Which rows can be accessed
WITH CHECK (condition) -- Which rows can be modified
```

---

## üîê Security Best Practices

### ‚úÖ What the Script Does

1. **Enables RLS:** Turns on row-level security for applications and programs tables
2. **Principle of Least Privilege:** Users can only access data they need
3. **Role-Based Access:** Different permissions for students, institutions, admins
4. **Audit Trail:** Prevents unauthorized modifications
5. **Defense in Depth:** Database-level security even if application code is compromised

### ‚ö†Ô∏è What to Avoid

- **Don't disable RLS:** Even temporarily in production
- **Don't use service_role key in frontend:** Only in backend/scripts
- **Don't rely solely on frontend validation:** Always enforce at database level
- **Don't share JWT secrets:** Keep SUPABASE_JWT_SECRET private

---

## üìû Need Help?

If you encounter issues:

1. **Check Supabase Logs:**
   - Dashboard ‚Üí Logs ‚Üí Database
   - Look for policy violation errors

2. **Verify User Data:**
   ```sql
   SELECT id, email, active_role, available_roles
   FROM users
   WHERE id = auth.uid()::text;
   ```

3. **Test Policy Manually:**
   ```sql
   -- This should work for authenticated students
   SET request.jwt.claims = '{"sub": "student-uuid-here"}';
   INSERT INTO applications (...) VALUES (...);
   ```

4. **Review the SQL File:** `setup_rls_policies.sql` has detailed comments explaining each policy

---

## ‚úÖ Completion Checklist

- [ ] Opened Supabase Dashboard
- [ ] Navigated to SQL Editor
- [ ] Copied `setup_rls_policies.sql` contents
- [ ] Pasted and executed in SQL Editor
- [ ] Saw success messages
- [ ] Verified policies in Database ‚Üí applications ‚Üí Policies tab
- [ ] Re-ran test: `python test_application_workflow.py`
- [ ] All tests passed
- [ ] Celebrated! üéâ

---

## üìù Next Steps

Once RLS is configured and all tests pass:

1. **Test with Real Data:**
   - Create actual student and institution accounts
   - Submit real applications
   - Verify document uploads work

2. **Frontend Integration:**
   - Update Flutter app to use production API
   - Test role-based UI elements
   - Verify permissions are properly enforced

3. **Monitor in Production:**
   - Set up alerts for policy violations
   - Review access logs periodically
   - Keep RLS policies updated as features evolve

---

**Last Updated:** November 17, 2025
**Version:** 1.0
**Platform:** Flow EdTech - Supabase + Railway
